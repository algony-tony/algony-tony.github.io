<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PQ63V8S');</script>
<!-- End Google Tag Manager -->

    


    <title>Tez 简介 – Algony Tony – etvdyn</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。
" />
    <meta property="og:description" content="Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。
" />
    
    <meta name="author" content="Algony Tony" />

    
    <meta property="og:title" content="Tez 简介" />
    <meta property="twitter:title" content="Tez 简介" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="Algony Tony - etvdyn" href="/feed.xml" />

    

    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3291441471504209"
     crossorigin="anonymous"></script>


    <link type="application/atom+xml" rel="alternate" href="https://algony-tony.github.io/feed.xml" title="Algony Tony" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Tez 简介 | Algony Tony</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Tez 简介" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。" />
<meta property="og:description" content="Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。" />
<link rel="canonical" href="https://algony-tony.github.io/tez-intro/" />
<meta property="og:url" content="https://algony-tony.github.io/tez-intro/" />
<meta property="og:site_name" content="Algony Tony" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-01T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Tez 简介" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-01T00:00:00+08:00","datePublished":"2022-09-01T00:00:00+08:00","description":"Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。","headline":"Tez 简介","mainEntityOfPage":{"@type":"WebPage","@id":"https://algony-tony.github.io/tez-intro/"},"url":"https://algony-tony.github.io/tez-intro/"}</script>
<!-- End Jekyll SEO tag -->


  </head>

  <body>

    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PQ63V8S"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


    <header class="site-header">

    <div class="wrapper-header">
      <div class="header-left">
        <!-- <a href="/" class="site-avatar"><img src="/assets/img/sys/jekyll-logo.png" alt="avatar" /></a> -->

        <a class="site-info" href="/">
          <span class="site-name">Algony Tony</span>
          <span class="site-description">etvdyn</span>
        </a>

      </div>

      <nav class="header-right">
        
        <a href="/"  class="page-link"  >
          首页
        </a>
        
        <a href="/WebMap/"  class="page-link"  >
          导航
        </a>
        
        <a href="/tools/"  class="page-link"  >
          工具
        </a>
        
        <a href="/collections/"  class="page-link"  >
          归档
        </a>
        
      </nav>
    </div>

</header>


    <main class="default-content" aria-label="内容区">
  <div class="wrapper-content">

    <article class="post">
      <div class="left">
        <h1>Tez 简介</h1>
        <div class="label">

          <div class="label-date">
            2022-09-01
          </div>

          <div class="label-category">
            <span >类别:</span>

<a class="category-link" href="https://algony-tony.github.io/category/#软件技术" title="Category: 软件技术">
  软件技术
</a>


          </div>

          <div class="label-tag">
            <span >标签:</span>

<a class="tag-link" href="https://algony-tony.github.io/tag/#Tez" title="Tag: Tez">
  Tez
</a>

<a class="tag-link" href="https://algony-tony.github.io/tag/#Hive" title="Tag: Hive">
  Hive
</a>

<a class="tag-link" href="https://algony-tony.github.io/tag/#Hadoop" title="Tag: Hadoop">
  Hadoop
</a>

          </div>

        </div>

        <div class="entry">
          <p>Tez 是一个处理复杂 DAG 数据处理任务的应用框架，它构建在 Hadoop Yarn 之上。Tez 是由 Hortonworks 牵头开发的计算框架。</p>

<p>下图是 Pig/Hive 在原 MR 框架和 Tez 框架上的比较图。MapReduce 是通用的分布式并行计算框架，由 Map 和 Reduce 两类简洁的接口来表示丰富的数据处理任务，但是也遇到一些挑战，在运行复杂任务时会生成多个 MapReduce 作业，作业直接的数据传输时通过分布式文件系统传递完成，也就是作业之间的数据会落盘，如下左图标记所示，这种设计提高了整体任务的稳定性也相应地增加了整体任务的执行时间。而且对于处理数据量少，启动和终止 MR 作业的开销显得就很高。</p>

<p><img src="/assets/img/post/tez-PigHiveQueryOnMR.png" alt="Pig/Hive on MR" title="Pig/Hive on MR" />
<img src="/assets/img/post/tez-PigHiveQueryOnTez.png" alt="Pig/Hive on Tez" title="Pig/Hive on Tez" /></p>

<p>一般的 MapReduce 任务的步骤如下：</p>
<ol>
  <li>从文件中读取数据（第一次磁盘操作）；</li>
  <li>执行 mapper 任务；</li>
  <li>写入 mapper 任务结果（第二次磁盘操作）；</li>
  <li>执行 shuffle 和 sort（读取 mapper 输出，第三次磁盘操作）；</li>
  <li>写入 shuffle 和 sort 结果（写入 sort 后的结果，第四次磁盘操作）；</li>
  <li>读取 sort 的结果执行 reducer 任务（第五次磁盘操作）；</li>
  <li>写入 reducer 任务结果（第六次磁盘操作）；</li>
</ol>

<p>DAG 可以看做是 MapReduce 之后的新一代计算模型，Spark 和 Tez 都是基于 DAG 模型，他们都受到微软提出的 Dryad 系统的影响。Tez 的操作和 Spark 很像，只有一次读和一次写磁盘操作，中间结果都是存在内存中。Tez 的执行快还有向量化的功劳，可以并行执行一批数据而不是一条一条处理。Tez 的主要步骤如下</p>
<ol>
  <li>执行 plan 但是没必要从磁盘读取数据；</li>
  <li>需要做计算的时候（类似 Spark 中的 action 算子），从磁盘读取数据执行所有的步骤并输出结果；</li>
</ol>

<p>Tez 目前主要和 Hive 组合使用，在 Hive 中用 <code class="language-plaintext highlighter-rouge">set hive.execution.engine=tez;</code> 开启使用。Tez 提供两种 API：</p>

<ul>
  <li>DAG API：使用 DAG 图来表示复杂数据流结构的 API；</li>
  <li>Runtime API：转换数据，指定每个任务具体的执行内容；</li>
</ul>

<p><img src="/assets/img/post/tez-components.png" alt="Tez 组件" title="Tez 组件" /></p>

<p>Tez AppMaster 负责调用 Yarn 分配的容器去完成任务，负责处理暂时失败的容器，负责和 Yarn ResourceManager 沟通分配和释放容器。
Tez AppMaster 对一个任务来说有单点失败的问题。</p>

<p><img src="/assets/img/post/tez-am.png" alt="Tez AppMaster and Task Container" title="Tez AppMaster and Task Container" /></p>

<p>下面是 Tez 的几个常用参数，这边是 <a href="https://tez.apache.org/releases/0.9.1/tez-api-javadocs/configs/TezConfiguration.html">0.9.1 版本的参数列表</a>：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">tez.am.resource.memory.mb</code>：tez AppMaster 内存，如果报出 out-of-memory(OOM) 的错误，可以调高这个参数，调整成 <code class="language-plaintext highlighter-rouge">yarn.scheduler.minimum-allocation-mb</code> 的整数倍，
别超过 <code class="language-plaintext highlighter-rouge">yarn.scheduler.maximum-allocation-mb</code> 。一般设置 <code class="language-plaintext highlighter-rouge">tez.am.resource.memory.mb=4096mb</code> 是够用的。</li>
  <li><code class="language-plaintext highlighter-rouge">hive.tez.container.size</code>：tez 任务容器的内存，设置的规则如上，可以根据任务适当调大内存。</li>
  <li><code class="language-plaintext highlighter-rouge">hive.auto.convert.join.noconditionaltask.size</code>：当设置 <code class="language-plaintext highlighter-rouge">hive.auto.convert.join.noconditionaltask=true</code> 时这个 size 参数才会起作用，对于 <code class="language-plaintext highlighter-rouge">n</code> 表 join 的情况，如果 <code class="language-plaintext highlighter-rouge">n-1</code> 个
表的大小之和小于这个数，就会自动转成 mapjoin，map-side join 是一种特殊类型的连接，其中较小的表加载到内存中，连接在 MapReduce 作业的 map 阶段执行。 由于 map-side join 中不涉及 reducer，因此与常规 join 相比，它要快得多。</li>
  <li><code class="language-plaintext highlighter-rouge">tez.am.container.reuse.enabled=true</code>：设置是否对多个查询复用容器，默认为 <code class="language-plaintext highlighter-rouge">true</code>，开启可以减少每次查询都重新分配容器所引起的内存额外开销。
<img src="/assets/img/post/tez-memory-parameter.png" alt="Tez 内存参数" title="Tez 内存参数" /></li>
</ol>

<p>Tez 有会话（session）的概念，当客户端或者 JDBC 工具发起一个 Hive 查询，它会启动一个 tez 会话，可以用于执行后续的多个查询。复用同一个会话可以节省每次查询时等待 Yarn 分配容器的时间。</p>

<h2 id="参考链接">参考链接</h2>

<p><a href="https://tez.apache.org/">Apache TEZ</a></p>

<p><a href="https://web.eecs.umich.edu/~mosharaf/Readings/Tez.pdf">Apache Tez: A Unifying Framework for Modeling and Building Data Processing Applications</a></p>

<p><a href="https://gihyo.jp/admin/serial/01/how_hadoop_works/0016">并行数据处理系统 Apache Tez</a></p>

<p><a href="https://tsktech.medium.com/apache-tez-2fd0d6a1d4e3">Apache Tez -Overview</a></p>

<p><a href="https://www.justanalytics.com/blog/technical-know-how/apache-hive-memory-management-tuning">Apache Hive and Apache Tez – Memory management and Tuning</a></p>

<p><a href="https://community.cloudera.com/t5/Support-Questions/Difference-between-mr-and-Tez/m-p/103672">Difference between mr and Tez?</a></p>

<p><a href="https://www.slideshare.net/Hadoop_Summit/w-235phall1pandey" title="包含各种条件下 MR 和 Tez 行为的不同，以及为什么 Tez 会比 MR 更快">Hive + Tez: A Performance Deep Dive</a></p>

<p><a href="https://blog.cloudera.com/optimizing-hive-on-tez-performance/">Optimizing Hive on Tez Performance</a></p>

<p><a href="https://cwiki.apache.org/confluence/display/TEZ/How+initial+task+parallelism+works">How initial task parallelism works</a></p>

<p><a href="https://zhuanlan.zhihu.com/p/63315907">深入剖析Tez原理</a></p>

        </div>

        
<div class="comments" id="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'https-algony-tony-github-io';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


      </div>

      

      

    </article>

  </div>
</main>

    
      <footer class="site-footer">

  <div class="wrapper-footer">
    <div class="social-wrapper">
      







<a href="/feed.xml"><i class="svg-icon rss"></i></a>




    </div>

    <div>
      <p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
    </div>

    <div>Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.</div>
  </div>

</footer>

    

  </body>
</html>

