<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PQ63V8S');</script>
<!-- End Google Tag Manager -->

    


    <title>在 Linux Shell 中如何只允许同时最多一个程序运行 – Algony Tony – etvdyn</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="主要介绍两种方案，使用 flock 命令，或者使用 pid 文件。" />
    <meta property="og:description" content="主要介绍两种方案，使用 flock 命令，或者使用 pid 文件。" />
    
    <meta name="author" content="Algony Tony" />

    
    <meta property="og:title" content="在 Linux Shell 中如何只允许同时最多一个程序运行" />
    <meta property="twitter:title" content="在 Linux Shell 中如何只允许同时最多一个程序运行" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    <link rel="alternate" type="application/rss+xml" title="Algony Tony - etvdyn" href="/feed.xml" />

    

    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3291441471504209"
     crossorigin="anonymous"></script>


    <link type="application/atom+xml" rel="alternate" href="https://algony-tony.github.io/feed.xml" title="Algony Tony" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>在 Linux Shell 中如何只允许同时最多一个程序运行 | Algony Tony</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="在 Linux Shell 中如何只允许同时最多一个程序运行" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="主要介绍两种方案，使用 flock 命令，或者使用 pid 文件。" />
<meta property="og:description" content="主要介绍两种方案，使用 flock 命令，或者使用 pid 文件。" />
<link rel="canonical" href="https://algony-tony.github.io/linux-one-process/" />
<meta property="og:url" content="https://algony-tony.github.io/linux-one-process/" />
<meta property="og:site_name" content="Algony Tony" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-03T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="在 Linux Shell 中如何只允许同时最多一个程序运行" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-03T00:00:00+08:00","datePublished":"2022-04-03T00:00:00+08:00","description":"主要介绍两种方案，使用 flock 命令，或者使用 pid 文件。","headline":"在 Linux Shell 中如何只允许同时最多一个程序运行","mainEntityOfPage":{"@type":"WebPage","@id":"https://algony-tony.github.io/linux-one-process/"},"url":"https://algony-tony.github.io/linux-one-process/"}</script>
<!-- End Jekyll SEO tag -->


  </head>

  <body>

    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PQ63V8S"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    
    <header class="site-header">

    <div class="wrapper-header">
      <div class="header-left">
        <!-- <a href="/" class="site-avatar"><img src="/assets/img/sys/jekyll-logo.png" alt="avatar" /></a> -->

        <a class="site-info" href="/">
          <span class="site-name">Algony Tony</span>
          <span class="site-description">etvdyn</span>
        </a>

      </div>
      
      <nav class="header-right">
        
        <a href="/"  class="page-link"  >
          首页
        </a>
        
        <a href="/WebMap/"  class="page-link"  >
          导航
        </a>
        
        <a href="/tools/"  class="page-link"  >
          工具
        </a>
        
        <a href="/collections/"  class="page-link"  >
          归档
        </a>
        
      </nav>
    </div>
    
</header>
  

    <main class="default-content" aria-label="内容区">
  <div class="wrapper-content">

    <article class="post">
      <div class="left">
        <h1>在 Linux Shell 中如何只允许同时最多一个程序运行</h1>
        <div class="label">

          <div class="label-date">
            2022-04-03
          </div>

          <div class="label-category">
            <span >类别:</span>

<a class="category-link" href="https://algony-tony.github.io/category/#软件技术" title="Category: 软件技术">
  软件技术
</a>


          </div>

          <div class="label-tag">
            <span >标签:</span>

<a class="tag-link" href="https://algony-tony.github.io/tag/#Linux" title="Tag: Linux">
  Linux
</a>

<a class="tag-link" href="https://algony-tony.github.io/tag/#shell" title="Tag: shell">
  shell
</a>

          </div>

        </div>

        <div class="entry">
          <p>在 Linux shell 中有时需要实现排他地同时最多只能一个进程运行，比如用 crontab 周期性执行程序，定时开始时可能之前周期运行的程序还没有结束退出，此时就需要用到下面几种方案。</p>

<h2 id="flock-命令">flock 命令</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><div class="line-1">flock <span class="nt">-xn</span> &lt;lock-file&gt; &lt;script&gt;
</div></code></pre></figure>

<p>Linux 里的文件锁主要两种，一种是协同锁（advisory lock），一种是强制锁（mandatory lock）,协同锁不是由操作系统或者文件系统设置，它要求参与操作的进程之间协同工作，
文件被协同锁锁定时也一样可以被系统调用去读写甚至删除，强制锁通过命令 <code class="language-plaintext highlighter-rouge">fcntl</code> 操作，linux 的强制锁使用有一定限制，而且 <a href="https://www.kernel.org/doc/Documentation/filesystems/mandatory-locking.txt">kernel 文件</a>中是建议尽量不用强制锁。</p>

<p><code class="language-plaintext highlighter-rouge">flock</code> 会给文件上协同锁，不同的进程可以通过 <code class="language-plaintext highlighter-rouge">flock</code> 命令协同工作。<code class="language-plaintext highlighter-rouge">-x</code> 参数是排他锁，这个是默认配置。如果已有进程给文件上锁，新启动的 <code class="language-plaintext highlighter-rouge">flock</code> 进程默认会一直等拿到锁再执行命令，
<code class="language-plaintext highlighter-rouge">-n</code> 是 nonblock，拿不到锁就立刻退出，exit code 默认是 1，可以通过参数 <code class="language-plaintext highlighter-rouge">-E</code> 指定其他 exit code。
<code class="language-plaintext highlighter-rouge">-w</code> 可以指定等待几秒后拿不到锁再退出。<code class="language-plaintext highlighter-rouge">-s</code> 是指定为共享锁，读锁。</p>

<p>下面两个命令可以查看 linux 系统锁。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><div class="line-1">lslocks
</div><div class="line-2"><span class="c"># COMMAND   PID  TYPE SIZE MODE  M START END PATH</span>
</div><div class="line-3"><span class="c"># flock   19619 FLOCK   4B WRITE 0     0   0 /home/tony/test/balance.dat</span>
</div><div class="line-4"><span class="nb">cat</span> /proc/locks
</div><div class="line-5"><span class="c"># 1: FLOCK  ADVISORY  WRITE 19619 08:10:83966 0 EOF</span>
</div></code></pre></figure>

<h2 id="使用-pid-文件">使用 PID 文件</h2>
<p>PID 文件就是普通的文本文件，只保存进程的 PID，这里面没有特别规则，只是一种约定。
使用 PID 文件的想法就是在进程开始前检查是否存在 PID 文件，及存储的 pid 进程是否有效，如果都是 True 则等待，否则开始启动本次 action，
结束后移除 PID 文件，防止程序意外退出加上 <code class="language-plaintext highlighter-rouge">trap</code> 命令捕捉 EXIT 信号只要退出就移除 PID 文件，但是进程被 <code class="language-plaintext highlighter-rouge">kill -9</code> 是无法被捕捉到，所以在检查 PID 文件的时候也要检查下该 pid 程序是否还有效。</p>

<p><code class="language-plaintext highlighter-rouge">trap</code> 命令允许捕获指定信号并在它们发生时执行代码。信号是发送到脚本的异步通知，<a href="https://man7.org/linux/man-pages/man7/signal.7.html">signal(7)</a> 页面有关于所有信号的介绍，
这篇 <a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html">Termination-Signals</a> 有关于主要几个中断信号的介绍，
<code class="language-plaintext highlighter-rouge">kill</code> 命令默认发送 SIGTERM 信号，<code class="language-plaintext highlighter-rouge">kill -9</code> 发送 SIGKILL 信号，CTRL-C 操作发送 SIGINT 信号，SIGTERM 信号可以被阻塞，处理和无视，是一种温和的中止信号，
而在 Linux 系统里进程如果收到 SIGKILL 信号必须马上中止，它不能被捕获和无视，自然也就无法被 <code class="language-plaintext highlighter-rouge">trap</code> 命令捕获。<a href="https://turnoff.us/">Turnoff</a> 上有一个有趣的漫画解释 <a href="https://turnoff.us/geek/dont-sigkill/">the real reason to not use sigkill</a></p>

<p><code class="language-plaintext highlighter-rouge">trap</code> 最常用的是捕捉名为 EXIT 的伪信号，可以在脚本退出时执行指定的命令，通常是一些收尾工作，删除临时文件等。<code class="language-plaintext highlighter-rouge">trap</code> 只对该命令之后的代码起作用，所以一般把 <code class="language-plaintext highlighter-rouge">trap</code> 命令放到文件开始处，<code class="language-plaintext highlighter-rouge">trap</code> 在捕获到相应信号，执行指定的命令后会继续执行中断命令后面的脚本，但是不会重新启动被中断的命令。</p>

<p>下面是使用 PID 文件的一个示例。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><div class="line-1"><span class="c">#!/bin/bash</span>
</div><div class="line-2">
</div><div class="line-3"><span class="nv">PIDFILE</span><span class="o">=</span><span class="s2">"/tmp/pidtest.pid"</span>
</div><div class="line-4">
</div><div class="line-5">create_pidfile <span class="o">()</span> <span class="o">{</span>
</div><div class="line-6">  <span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span>
</div><div class="line-7"><span class="o">}</span>
</div><div class="line-8">
</div><div class="line-9">remove_pidfile <span class="o">()</span> <span class="o">{</span>
</div><div class="line-10">  <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span>
</div><div class="line-11"><span class="o">}</span>
</div><div class="line-12">
</div><div class="line-13"><span class="c"># 若存在 PID 文件且 pid 有效则 true，否则 false</span>
</div><div class="line-14">check_pidfile <span class="o">()</span> <span class="o">{</span>
</div><div class="line-15">  <span class="c"># 申明函数局部变量</span>
</div><div class="line-16">  <span class="nb">local </span>prevpid
</div><div class="line-17">  <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</div><div class="line-18"><span class="k">    </span><span class="nv">prevpid</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$PIDFILE</span><span class="s2">"</span><span class="si">)</span>
</div><div class="line-19">    <span class="c"># 参考 man 2 kill</span>
</div><div class="line-20">    <span class="c"># kill -0 不会发送信号，只会检查是否可执行，可以用作检查进程是否还存在</span>
</div><div class="line-21">    <span class="c"># 进程存在，且有权限则返回 0，否则返回 1</span>
</div><div class="line-22">    <span class="c"># 在 shell 中 1 表示 false，0 是 true</span>
</div><div class="line-23">    <span class="nb">kill</span> <span class="nt">-0</span> <span class="nv">$prevpid</span> 2&gt;/dev/null
</div><div class="line-24">  <span class="k">else</span>
</div><div class="line-25"><span class="k">    </span><span class="nb">false</span>
</div><div class="line-26"><span class="nb">  </span><span class="k">fi</span>
</div><div class="line-27"><span class="o">}</span>
</div><div class="line-28">
</div><div class="line-29">do_action <span class="o">()</span> <span class="o">{</span>
</div><div class="line-30">  <span class="nb">echo</span> <span class="s2">"do action..."</span>
</div><div class="line-31">  <span class="nb">sleep </span>300
</div><div class="line-32"><span class="o">}</span>
</div><div class="line-33">
</div><div class="line-34"><span class="nb">trap </span>remove_pidfile EXIT
</div><div class="line-35"><span class="k">if</span> <span class="o">!</span> check_pidfile <span class="p">;</span><span class="k">then</span>
</div><div class="line-36"><span class="k">  </span>create_pidfile
</div><div class="line-37">  do_action
</div><div class="line-38"><span class="k">fi</span>
</div></code></pre></figure>

<h3 id="参考">参考</h3>
<p><a href="https://www.baeldung.com/linux/bash-ensure-instance-running">Ensure Only One Instance of a Bash Script Is Running</a></p>

<p><a href="https://www.baeldung.com/linux/file-locking">Introduction to File Locking in Linux</a></p>

<p><a href="https://www.baeldung.com/linux/pid-file#ensuring-a-single-instance-of-an-application">What is a .pid File?</a></p>

<p><a href="https://linux.die.net/man/1/flock">flock(1) - Linux man page</a></p>

<p><a href="https://www.linuxjournal.com/content/bash-trap-command">The Bash Trap Command</a></p>

        </div>

        
<div class="comments" id="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'https-algony-tony-github-io';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


      </div>

      

      

    </article>
    
  </div>
</main>

    
      <footer class="site-footer">

  <div class="wrapper-footer">
    <div class="social-wrapper">
      







<a href="/feed.xml"><i class="svg-icon rss"></i></a>




    </div>

    <div>
      <p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
    </div>

    <div>Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.</div>
  </div>

</footer>

    

  </body>
</html>

